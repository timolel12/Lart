<div class="checkout-page" *ngIf="cart$ | async as cart">
  <header class="checkout-header">
    <h1 class="checkout-title">Bestellung abschließen</h1>
  </header>
  <nav class="stepper stepper-left" aria-label="Checkout Schritte">
    <div class="step" [class.active]="step === 1" [class.done]="step > 1">
      <span class="step-dot"></span>
      <span class="step-label">Lieferdaten</span>
    </div>
    <div class="step-sep"></div>
    <div class="step" [class.active]="step === 2" [class.disabled]="step < 2">
      <span class="step-dot"></span>
      <span class="step-label">Zahlung</span>
    </div>
  </nav>
  <div *ngIf="cart.items.length; else emptyCheckout" class="layout">
    <!-- LEFT -->
    <section class="stage">
      <!-- STEP 1 -->
      <form
        *ngIf="step === 1"
        class="panel"
        [formGroup]="addressForm"
        (ngSubmit)="submitAddress()"
        novalidate
      >
        <div class="panel-head">
          <span class="step-tag">Schritt 1/2</span>
          <h2 class="panel-title">Lieferdetails</h2>
        </div>
        <p class="panel-sub">
          Wir nutzen deine Angaben ausschließlich zur Abwicklung der Bestellung.
        </p>

        <!-- Persönliche Daten -->
        <h3 class="group-title">Persönliche Daten</h3>
        <div class="grid two" formGroupName="personal">
          <label class="field" [class.invalid]="invalid('personal.firstName')">
            <span>Vorname</span>
            <input type="text" formControlName="firstName" placeholder="Max" />
            <small class="error" *ngIf="invalid('personal.firstName')"
              >Bitte Vornamen eingeben</small
            >
          </label>

          <label class="field" [class.invalid]="invalid('personal.lastName')">
            <span>Nachname</span>
            <input
              type="text"
              formControlName="lastName"
              placeholder="Mustermann"
            />
            <small class="error" *ngIf="invalid('personal.lastName')"
              >Bitte Nachnamen eingeben</small
            >
          </label>
        </div>

        <label
          class="field"
          formGroupName="personal"
          [class.invalid]="invalid('personal.email')"
        >
          <span>E-Mail</span>
          <input
            type="email"
            formControlName="email"
            placeholder="max@beispiel.de"
          />
          <small class="error" *ngIf="invalid('personal.email')"
            >Bitte gültige E-Mail eingeben.</small
          >
        </label>

        <!-- Adresse -->
        <h3 class="group-title">Adresse</h3>
        <div formGroupName="location">
          <label class="field" [class.invalid]="invalid('location.street')">
            <span>Straße und Nr.</span>
            <input
              type="text"
              formControlName="street"
              placeholder="Musterstraße 1"
            />
            <small class="error" *ngIf="invalid('location.street')"
              >Bitte Straße & Hausnr. angeben.</small
            >
          </label>

          <div class="grid three">
            <label class="field" [class.invalid]="invalid('location.zip')">
              <span>PLZ</span>
              <input
                type="text"
                inputmode="numeric"
                maxlength="5"
                formControlName="zip"
                placeholder="12345"
              />
              <small class="error" *ngIf="invalid('location.zip')"
                >5-stellige PLZ.</small
              >
            </label>

            <label
              class="field span-two"
              [class.invalid]="invalid('location.city')"
            >
              <span>Ort</span>
              <input type="text" formControlName="city" placeholder="Berlin" />
              <small class="error" *ngIf="invalid('location.city')"
                >Bitte Ort angeben.</small
              >
            </label>
          </div>
        </div>

        <div class="actions">
          <button
            mat-raised-button
            color="primary"
            class="primary-button"
            type="submit"
            [disabled]="
              addressForm.pending ||
              addressForm.invalid ||
              !consentControl.value
            "
          >
            Weiter zur Zahlung
          </button>
        </div>
      </form>

      <!-- STEP 2 -->
      <div *ngIf="step === 2" class="panel">
        <div class="panel-head">
          <span class="step-tag">Schritt 2/2</span>
          <h2 class="panel-title">Bestellung bezahlen</h2>
        </div>
        <p class="panel-sub">Wähle deine Zahlungsart.</p>

        <div class="payment-list">
          <!-- PayPal -->
          <label
            class="payment-tile"
            [class.active]="paymentControl.value === 'paypal'"
          >
            <input type="radio" [formControl]="paymentControl" value="paypal" />

            <div class="tile-main">
              <div class="tile-left">
                <img src="assets/images/PayPal.svg" alt="PayPal" />
                <span>PayPal</span>
              </div>
              <div class="tile-right"><span class="badge">Empfohlen</span></div>
            </div>

            <div
              class="tile-expand"
              *ngIf="paymentControl.value === 'paypal'"
              (click)="$event.stopPropagation()"
            >
              <button class="paypal-btn" (click)="payWithPaypal()">
                <img src="assets/images/PayPal.svg" alt="" />
              </button>
            </div>
          </label>

          <!-- Sofort -->
          <label
            class="payment-tile"
            [class.active]="paymentControl.value === 'sofort'"
          >
            <input type="radio" [formControl]="paymentControl" value="sofort" />

            <div class="tile-main">
              <div class="tile-left">
                <img src="assets/images/klarna_logo.png" alt="Klarna Sofort" />
                <span>Sofortüberweisung</span>
              </div>
            </div>

            <div
              class="tile-expand"
              *ngIf="paymentControl.value === 'sofort'"
              (click)="$event.stopPropagation()"
            >
              <button class="sofort-btn" (click)="payWithSofort()">
                Mit Sofortüberweisung bezahlen
              </button>
            </div>
          </label>

          <!-- Apple Pay -->
          <label
            class="payment-tile"
            [class.active]="paymentControl.value === 'applepay'"
          >
            <input
              type="radio"
              [formControl]="paymentControl"
              value="applepay"
            />

            <div class="tile-main">
              <div class="tile-left">
                <img src="assets/images/Apple_Pay_logo.svg" alt="Apple Pay" />
                <span>Apple Pay</span>
              </div>
            </div>

            <div
              class="tile-expand"
              *ngIf="paymentControl.value === 'applepay'"
              (click)="$event.stopPropagation()"
            >
              <button class="apple-btn" (click)="payWithApplePay()">Pay</button>
            </div>
          </label>

          <!-- Card -->
          <label
            class="payment-tile"
            [class.active]="paymentControl.value === 'card'"
          >
            <input type="radio" [formControl]="paymentControl" value="card" />

            <!-- header row -->
            <div class="tile-main">
              <div class="tile-left">
                <mat-icon class="card-icon">credit_card</mat-icon>
                <span>Kartenzahlung</span>
              </div>
              <div class="tile-right card-brands">
                <img
                  src="assets/images/mastercard.svg"
                  alt="Mastercard"
                  class="brand-logo-mastercard"
                />
                <img
                  src="assets/images/Visa.png"
                  alt="Visa"
                  class="brand-logo-visa"
                />
              </div>
            </div>
            <div
              class="tile-expand"
              *ngIf="paymentControl.value === 'card'"
              (click)="$event.stopPropagation()"
            >
              <form [formGroup]="cardForm" (ngSubmit)="payWithCard()">
                <p class="panel-sub">
                  Alle Felder sind Pflichtfelder, sofern nicht anders
                  gekennzeichnet.
                </p>

                <!-- Kartennummer -->
                <label class="field" [class.invalid]="cardInvalid('number')">
                  <span>Kartennummer</span>
                  <div style="position: relative">
                    <input
                      formControlName="number"
                      type="text"
                      inputmode="numeric"
                      placeholder="1234 5678 9012 3456"
                      autocomplete="cc-number"
                      maxlength="23"
                      (input)="formatCardNumber($event)"
                    />
                    <mat-icon
                      style="
                        position: absolute;
                        right: 10px;
                        top: 50%;
                        transform: translateY(-50%);
                        opacity: 0.8;
                      "
                      >credit_card</mat-icon
                    >
                  </div>
                  <small class="error" *ngIf="cardInvalid('number')">
                    Bitte gültige Kartennummer eingeben.
                  </small>
                </label>

                <!-- Ablaufdatum -->
                <label class="field" [class.invalid]="cardInvalid('expiry')">
                  <span>Ablaufdatum</span>
                  <div style="position: relative">
                    <input
                      formControlName="expiry"
                      type="text"
                      inputmode="numeric"
                      placeholder="MM/JJ"
                      autocomplete="cc-exp"
                      maxlength="5"
                      (input)="formatExpiry($event)"
                    />
                    <mat-icon
                      style="
                        position: absolute;
                        right: 10px;
                        top: 50%;
                        transform: translateY(-50%);
                        opacity: 0.8;
                      "
                      >event</mat-icon
                    >
                  </div>
                  <small class="error" *ngIf="cardInvalid('expiry')">
                    Bitte gültiges Ablaufdatum (MM/JJ) eingeben.
                  </small>
                </label>

                <!-- Sicherheitscode -->
                <label class="field" [class.invalid]="cardInvalid('cvc')">
                  <span>Sicherheitscode</span>
                  <div style="position: relative">
                    <input
                      formControlName="cvc"
                      type="text"
                      inputmode="numeric"
                      placeholder="CVC"
                      autocomplete="cc-csc"
                      maxlength="3"
                    />
                    <mat-icon
                      style="
                        position: absolute;
                        right: 10px;
                        top: 50%;
                        transform: translateY(-50%);
                        opacity: 0.8;
                      "
                      >lock</mat-icon
                    >
                  </div>
                  <small class="error" *ngIf="cardInvalid('cvc')">
                    Der CVC muss 3 Ziffern enthalten.
                  </small>
                </label>

                <!-- Pay button -->
                <button
                  type="submit"
                  class="primary-button pay-btn"
                  [disabled]="
                    cardForm.invalid ||
                    processing ||
                    paymentControl.value !== 'card'
                  "
                >
                  <mat-icon aria-hidden="true">lock</mat-icon>
                  ZAHLE {{ cart.totalPrice + shippingCost | currency: "EUR":"symbol":"1.2-2" }}
                </button>
              </form>
            </div>
          </label>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="summary" aria-labelledby="summaryTitle">
      <div class="summary-card">
        <div class="summary-head">
          <h3 id="summaryTitle">Bestätige deine Bestellung</h3>
          <span class="summary-sub">
            {{ cart.items.length }} Gegenstand<span
              *ngIf="cart.items.length > 1"
              >e</span
            >
            im Warenkorb
          </span>
        </div>

        <!-- Artikel-Liste -->
        <ul class="summary-list">
          <li *ngFor="let item of cart.items" class="summary-item">
            <img [src]="item.imageUrl" [alt]="item.title" />
            <div class="info">
              <div class="title">{{ item.title }}</div>
              <div class="meta">Menge: {{ item.quantity }}</div>
            </div>
            <div class="price">
              {{ item.price * item.quantity | currency: "EUR" }}
            </div>
          </li>
        </ul>

        <!-- Summe -->
        <div class="summary-total">
          <div class="row">
            <span>Zwischensumme</span>
            <span>{{ cart.totalPrice | currency: "EUR" }}</span>
          </div>
          <div class="row">
            <span>Versand (DHL)</span>
            <span>{{ shippingCost | currency: "EUR" }}</span>
          </div>
          <div class="row strong">
            <span>Gesamt</span>
            <span>{{ cart.totalPrice + shippingCost | currency: "EUR" }}</span>
          </div>
          <p class="price-note" aria-live="polite">
            Alle Preise sind Endpreise zzgl. Versandkosten.
            Aufgrund der Kleinunternehmerregelung nach § 19 UStG wird keine Umsatzsteuer erhoben.
          </p>
        </div>

        <!-- Widerruf (steuert Button-Disable in Step 2) -->
        <div class="summary-consent">
          <label class="check">
            <input type="checkbox" [formControl]="consentControl" />
            <span
              >Von meinem <a href="#">Widerrufsrecht</a> habe ich Kenntnis
              genommen …</span
            >
          </label>
        </div>

        <button
          *ngIf="step === 2"
          mat-raised-button
          class="primary-button wide"
          (click)="placeOrder()"
          [disabled]="addressForm.invalid || !consentControl.value"
        >
          Jetzt bezahlen
        </button>
      </div>
    </aside>
  </div>

  <ng-template #emptyCheckout>
    <div class="checkout-empty">
      🛒 Dein Warenkorb ist leer. <a routerLink="/">Jetzt shoppen</a>
    </div>
  </ng-template>
</div>
